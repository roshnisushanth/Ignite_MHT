IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_hick_GetMUreport_Popup]') AND type in (N'P', N'PC'))
BEGIN
	DROP PROCEDURE [dbo].[sp_hick_GetMUreport_Popup]
	PRINT 'Dropped [dbo].[sp_hick_GetMUreport_Popup]'
END	
GO

Create PROCEDURE [dbo].[sp_hick_GetMUreport_Popup]
@physicanid bigint,
@Q1_start varchar (10)=null,
@Q1_end varchar (10)=null,
@Q2_start varchar (10)=null,
@Q2_end varchar (10)=null,
@Q3_start varchar (10)=null,
@Q3_end varchar (10)=null,
@Q4_start varchar (10)=null,
@Q4_end varchar (10)=null,
@measure int

AS
BEGIN

declare @sqlMUNumer varchar(max)
declare @sqlMUAuthNumer varchar(max)
create table #auditDetails(patient_id bigint,patientFirstName varchar(max),patientLastName varchar(max),Audit_Date varchar (15),Audit_Time varchar(15),InformationType varchar(10),DataValue varchar(10))
if(@measure=1)
begin

set @sqlMUNumer= ('select HU.ID as patient_id,Firstname as patientFirstName ,Lastname as patientLastName,CONVERT(DATE,ActionDate)Audit_Date,CONVERT(TIME(0),ActionDate) Audit_Time,InformationType,
Case When Type =1 Then ''Download''
     When Type=2 Then ''Transmit''
     Else ''View'' End from  Hick_Users HU inner join dbo.Audit HA
on HU.ID = HA.UserId inner join hick_physician_mapping hpm on HU.ID = HPM.patientid 
inner join Hick_SessionNote HSN on HU.ID = HSN.ToId 
where (')
if (@Q1_start is not NULL AND @Q1_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q1_start+''',103) and CONVERT(datetime,'''+@Q1_end+''',103)) Or'
	End
if (@Q2_start is not NULL AND @Q2_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q2_start+''',103) and CONVERT(datetime,'''+@Q2_end+''',103)) or'
End
if (@Q3_start is not NULL AND @Q3_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q3_start+''',103) and CONVERT(datetime,'''+@Q3_end+''',103)) or'
End
if (@Q4_start is not NULL AND @Q4_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q4_start+''',103) and CONVERT(datetime,'''+@Q4_end+''',103)) or'
	End
set @sqlMUNumer=LEFT(@sqlMUNumer,DATALENGTH(@sqlMUNumer)-2)
set @sqlMUNumer = @sqlMUNumer + ')'

if(@physicanid <>0)
begin
set @sqlMUNumer = @sqlMUNumer + ' and HPM.physicianId ='+convert(varchar,@physicanid)+''
end
insert into #auditDetails
exec (@sqlMUNumer)

end
if(@measure=2)
begin
set @sqlMUNumer= ('select HU.ID as patient_id,Firstname as patientFirstName ,Lastname as patientLastName,CONVERT(DATE,ActionDate)Audit_Date,CONVERT(TIME(0),ActionDate) Audit_Time,InformationType,
Case When Type =1 Then ''Download''
     When Type=2 Then ''Transmit''
     Else ''View'' End from  Hick_Users HU inner join dbo.Audit HA
on HU.ID = HA.UserId inner join hick_physician_mapping hpm on HU.ID = HPM.patientid 
inner join Hick_SessionNote HSN on HU.ID = HSN.ToId 
where (')
set @sqlMUAuthNumer= (' Union all select HU.ID as patient_id, Firstname as patientFirstName ,Lastname as patientLastName,CONVERT(DATE,ActionDate)Audit_Date,CONVERT(TIME(0),ActionDate) Audit_Time,InformationType,
Case When Type =1 Then ''Download''
     When Type=2 Then ''Transmit''
     Else ''View'' End  from IgniteAuthorizedRepMapping HAMP 
inner join dbo.Audit HA  on HAMP.AuthorizedUserId =HA.UserId
inner join Hick_Users HU  on HAMP.UserId=HU.ID
inner join hick_physician_mapping hpm on HU.ID = HPM.patientid 
inner join Hick_SessionNote HSN on HU.ID = HSN.ToId 
where (')
if (@Q1_start is not NULL AND @Q1_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q1_start+''',103) and CONVERT(datetime,'''+@Q1_end+''',103)) Or'
	set @sqlMUAuthNumer = @sqlMUAuthNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q1_start+''',103) and CONVERT(datetime,'''+@Q1_end+''',103)) Or'
End
if (@Q2_start is not NULL AND @Q2_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q2_start+''',103) and CONVERT(datetime,'''+@Q2_end+''',103)) or'
	set @sqlMUAuthNumer = @sqlMUAuthNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q2_start+''',103) and CONVERT(datetime,'''+@Q2_end+''',103)) or'
End
if (@Q3_start is not NULL AND @Q3_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q3_start+''',103) and CONVERT(datetime,'''+@Q3_end+''',103)) or'
	set @sqlMUAuthNumer = @sqlMUAuthNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q3_start+''',103) and CONVERT(datetime,'''+@Q3_end+''',103)) or'
End
if (@Q4_start is not NULL AND @Q4_end is not NULL)
Begin
	set @sqlMUNumer = @sqlMUNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q4_start+''',103) and CONVERT(datetime,'''+@Q4_end+''',103)) or'
	set @sqlMUAuthNumer = @sqlMUAuthNumer +' (HA.ActionDate between CONVERT(datetime,'''+@Q4_start+''',103) and CONVERT(datetime,'''+@Q4_end+''',103)) or'
End
set @sqlMUNumer=LEFT(@sqlMUNumer,DATALENGTH(@sqlMUNumer)-2)
set @sqlMUNumer = @sqlMUNumer + ')'
set @sqlMUAuthNumer=LEFT(@sqlMUAuthNumer,DATALENGTH(@sqlMUAuthNumer)-2)
set @sqlMUAuthNumer = @sqlMUAuthNumer + ')'
if(@physicanid <>0)
begin
set @sqlMUNumer = @sqlMUNumer + ' and HPM.physicianId ='+convert(varchar,@physicanid)+''
set @sqlMUAuthNumer = @sqlMUAuthNumer + ' and HPM.physicianId = '+convert(varchar,@physicanid)+''
end

print (@sqlMUNumer +@sqlMUAuthNumer)
insert into #auditDetails
exec (@sqlMUNumer +@sqlMUAuthNumer)
end

select * from #auditDetails
END


GO
PRINT 'Created UDF: sp_hick_GetMUreport_Popup'
Go


